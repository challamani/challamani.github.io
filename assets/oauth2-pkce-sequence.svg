<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1040" height="520" viewBox="0 0 1040 520" aria-labelledby="title desc">
  <title id="title">OAuth2 PKCE Sequence Diagram</title>
  <desc id="desc">Sequence diagram showing Authorization Code + PKCE flow.</desc>
  <style>
    .actor { font: 14px/1.2 "Segoe UI", Roboto, Arial, sans-serif; fill: #111; }
    .box { fill:#fff; stroke:#222; stroke-width:1; rx:6; }
    .lifeline { stroke:#bbb; stroke-dasharray:4 6; stroke-width:1; }
    .arrow { fill:none; stroke:#0b76ef; stroke-width:2.5; marker-end:url(#arrowhead); }
    .label { font:13px/1.2 "Segoe UI", Roboto, Arial, sans-serif; fill:#000; font-weight:600; }
    .label-outline { font:13px/1.2 "Segoe UI", Roboto, Arial, sans-serif; fill:none; stroke:#fff; stroke-width:3; stroke-linejoin:round; paint-order:stroke; }
  </style>

  <defs>
    <marker id="arrowhead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0b76ef" />
    </marker>
  </defs>

  <!-- Actor boxes -->
  <!-- positions: left to right -->
  <g id="actors">
    <g transform="translate(40,20)">
      <rect class="box" x="0" y="0" width="160" height="36" />
      <text class="actor" x="80" y="24" text-anchor="middle">User</text>
    </g>
    <g transform="translate(280,20)">
      <rect class="box" x="0" y="0" width="160" height="36" />
      <text class="actor" x="80" y="24" text-anchor="middle">ClientApp</text>
    </g>
    <g transform="translate(520,20)">
      <rect class="box" x="0" y="0" width="160" height="36" />
      <text class="actor" x="80" y="24" text-anchor="middle">AuthServer</text>
    </g>
    <g transform="translate(760,20)">
      <rect class="box" x="0" y="0" width="160" height="36" />
      <text class="actor" x="80" y="24" text-anchor="middle">ResourceServer</text>
    </g>
  </g>

  <!-- Lifelines (centers at x = 120, 360, 600, 840) -->
  <line class="lifeline" x1="120" y1="80" x2="120" y2="480" />
  <line class="lifeline" x1="360" y1="80" x2="360" y2="480" />
  <line class="lifeline" x1="600" y1="80" x2="600" y2="480" />
  <line class="lifeline" x1="840" y1="80" x2="840" y2="480" />

  <!-- Arrows following the Mermaid sequence exactly -->
  <!-- y positions -->
  <!-- step 1 -->
  <path class="arrow" d="M120 120 L 360 120" />
  <text class="label-outline" x="240" y="110" text-anchor="middle">(1)Access protected resource</text>
  <text class="label" x="240" y="110" text-anchor="middle">(1)Access protected resource</text>

  <!-- step 2 -->
  <path class="arrow" d="M360 160 L 600 160" />
  <text class="label-outline" x="480" y="150" text-anchor="middle">(2)Redirect to Authorization Endpoint</text>
  <text class="label" x="480" y="150" text-anchor="middle">(2)Redirect to Authorization Endpoint</text>

  <!-- step 3 -->
  <path class="arrow" d="M600 200 L 120 200" />
  <text class="label-outline" x="360" y="190" text-anchor="middle">(3)Prompt for login and consent</text>
  <text class="label" x="360" y="190" text-anchor="middle">(3)Prompt for login and consent</text>

  <!-- step 4 -->
  <path class="arrow" d="M120 240 L 600 240" />
  <text class="label-outline" x="360" y="230" text-anchor="middle">(4)Submit credentials and consent</text>
  <text class="label" x="360" y="230" text-anchor="middle">(4)Submit credentials and consent</text>

  <!-- step 5 -->
  <path class="arrow" d="M600 280 L 360 280" />
  <text class="label-outline" x="480" y="270" text-anchor="middle">(5)Redirect back with Authorization Code</text>
  <text class="label" x="480" y="270" text-anchor="middle">(5)Redirect back with Authorization Code</text>

  <!-- step 6 -->
  <path class="arrow" d="M360 320 L 600 320" />
  <text class="label-outline" x="480" y="310" text-anchor="middle">(6)Exchange Code for Access Token</text>
  <text class="label" x="480" y="310" text-anchor="middle">(6)Exchange Code for Access Token</text>

  <!-- step 7 -->
  <path class="arrow" d="M600 360 L 360 360" />
  <text class="label-outline" x="480" y="350" text-anchor="middle">(7)Return Access Token</text>
  <text class="label" x="480" y="350" text-anchor="middle">(7)Return Access Token</text>

  <!-- step 8 -->
  <path class="arrow" d="M360 400 L 840 400" />
  <text class="label-outline" x="600" y="390" text-anchor="middle">(8)Access protected resource with Access Token</text>
  <text class="label" x="600" y="390" text-anchor="middle">(8)Access protected resource with Access Token</text>

  <!-- step 9 -->
  <path class="arrow" d="M840 440 L 360 440" />
  <text class="label-outline" x="600" y="430" text-anchor="middle">(9)Return protected resource</text>
  <text class="label" x="600" y="430" text-anchor="middle">(9)Return protected resource</text>

</svg>
