<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="360" viewBox="0 0 1000 360" aria-labelledby="title desc">
  <title id="title">OAuth2 PKCE Sequence Diagram</title>
  <desc id="desc">Sequence diagram showing PKCE authorization code flow between User Agent, Client (public), Authorization Server and Resource Server.</desc>
  <style>
    .actor { font: 14px/1.2 "Segoe UI", Roboto, Arial, sans-serif; fill: #111; }
    .box { fill:#f7f9fb; stroke:#cbd6df; stroke-width:1.5; rx:6; }
    .lifeline { stroke:#cbd6df; stroke-dasharray:4 6; }
    .arrow { fill:none; stroke:#0b76ef; stroke-width:2; marker-end:url(#arrowhead); }
    .note { font:12px/1.2 "Segoe UI", Roboto, Arial, sans-serif; fill:#333; }
  </style>

  <defs>
    <marker id="arrowhead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#0b76ef" />
    </marker>
  </defs>

  <!-- Actors -->
  <g transform="translate(40,20)">
    <rect class="box" x="0" y="0" width="150" height="36" />
    <text class="actor" x="75" y="22" text-anchor="middle">User Agent</text>
  </g>

  <g transform="translate(260,20)">
    <rect class="box" x="0" y="0" width="170" height="36" />
    <text class="actor" x="85" y="22" text-anchor="middle">Client (Public)</text>
  </g>

  <g transform="translate(540,20)">
    <rect class="box" x="0" y="0" width="200" height="36" />
    <text class="actor" x="100" y="22" text-anchor="middle">Authorization Server</text>
  </g>

  <g transform="translate(820,20)">
    <rect class="box" x="0" y="0" width="150" height="36" />
    <text class="actor" x="75" y="22" text-anchor="middle">Resource Server</text>
  </g>

  <!-- Lifelines -->
  <line class="lifeline" x1="115" y1="80" x2="115" y2="320" />
  <line class="lifeline" x1="345" y1="80" x2="345" y2="320" />
  <line class="lifeline" x1="640" y1="80" x2="640" y2="320" />
  <line class="lifeline" x1="895" y1="80" x2="895" y2="320" />

  <!-- Steps -->
  <!-- 0. PKCE generation (client-side) -->
  <text class="note" x="200" y="100">1. Client generates code_verifier &amp; code_challenge</text>

  <!-- 1. Authorization Request -->
  <g>
    <path class="arrow" d="M 140 130 L 320 130" />
    <text class="note" x="230" y="120" text-anchor="middle">Authorization Request (client_id, redirect_uri, code_challenge, ...)</text>
  </g>

  <!-- 2. User authenticates &amp; consents (Auth server) -->
  <g>
    <path class="arrow" d="M 520 165 L 352 165" stroke="#888" />
    <text class="note" x="440" y="155" text-anchor="middle">Auth Server: prompt for login/consent</text>
  </g>

  <!-- 3. Authorization Response (redirect with code) -->
  <g>
    <path class="arrow" d="M 320 200 L 140 200" />
    <text class="note" x="230" y="190" text-anchor="middle">Authorization Response (redirect with code)</text>
  </g>

  <!-- 4. Client receives code via User Agent -->
  <text class="note" x="220" y="230">2. User Agent -> Client: authorization code</text>

  <!-- 5. Token Request (with code_verifier) -->
  <g>
    <path class="arrow" d="M 360 260 L 620 260" />
    <text class="note" x="490" y="250" text-anchor="middle">Token Request (code, code_verifier, client_id)</text>
  </g>

  <!-- 6. Token Response -->
  <g>
    <path class="arrow" d="M 620 290 L 360 290" />
    <text class="note" x="490" y="280" text-anchor="middle">Token Response (access_token, refresh_token?)</text>
  </g>

  <!-- 7. Client uses access token to call Resource Server -->
  <g>
    <path class="arrow" d="M 510 320 L 870 320" />
    <text class="note" x="690" y="310" text-anchor="middle">Protected Resource Request (Authorization: Bearer token)</text>
  </g>

  <!-- 8. Resource Server returns resource -->
  <g>
    <path class="arrow" d="M 870 350 L 510 350" transform="translate(0,-40)" />
    <text class="note" x="690" y="345" text-anchor="middle">Resource Response (data)</text>
  </g>

  <!-- Footnote -->
  <text class="note" x="40" y="345">PKCE prevents intercepted authorization codes being exchanged without the original code_verifier.</text>

</svg>
